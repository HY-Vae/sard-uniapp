import { Canvas } from 'canvas'

import { ALPHANUMERIC_CHARS, ECLList, qrcode, random } from '../../../utils'

const charCapacities = [
  [
    [41, 25, 17],
    [77, 47, 32],
    [127, 77, 53],
    [187, 114, 78],
    [255, 154, 106],
    [322, 195, 134],
    [370, 224, 154],
    [461, 279, 192],
    [552, 335, 230],
    [652, 395, 271],
    [772, 468, 321],
    [883, 535, 367],
    [1022, 619, 425],
    [1101, 667, 458],
    [1250, 758, 520],
    [1408, 854, 586],
    [1548, 938, 644],
    [1725, 1046, 718],
    [1903, 1153, 792],
    [2061, 1249, 858],
    [2232, 1352, 929],
    [2409, 1460, 1003],
    [2620, 1588, 1091],
    [2812, 1704, 1171],
    [3057, 1853, 1273],
    [3283, 1990, 1367],
    [3517, 2132, 1465],
    [3669, 2223, 1528],
    [3909, 2369, 1628],
    [4158, 2520, 1732],
    [4417, 2677, 1840],
    [4686, 2840, 1952],
    [4965, 3009, 2068],
    [5253, 3183, 2188],
    [5529, 3351, 2303],
    [5836, 3537, 2431],
    [6153, 3729, 2563],
    [6479, 3927, 2699],
    [6743, 4087, 2809],
    [7089, 4296, 2953],
  ],
  [
    [34, 20, 14],
    [63, 38, 26],
    [101, 61, 42],
    [149, 90, 62],
    [202, 122, 84],
    [255, 154, 106],
    [293, 178, 122],
    [365, 221, 152],
    [432, 262, 180],
    [513, 311, 213],
    [604, 366, 251],
    [691, 419, 287],
    [796, 483, 331],
    [871, 528, 362],
    [991, 600, 412],
    [1082, 656, 450],
    [1212, 734, 504],
    [1346, 816, 560],
    [1500, 909, 624],
    [1600, 970, 666],
    [1708, 1035, 711],
    [1872, 1134, 779],
    [2059, 1248, 857],
    [2188, 1326, 911],
    [2395, 1451, 997],
    [2544, 1542, 1059],
    [2701, 1637, 1125],
    [2857, 1732, 1190],
    [3035, 1839, 1264],
    [3289, 1994, 1370],
    [3486, 2113, 1452],
    [3693, 2238, 1538],
    [3909, 2369, 1628],
    [4134, 2506, 1722],
    [4343, 2632, 1809],
    [4588, 2780, 1911],
    [4775, 2894, 1989],
    [5039, 3054, 2099],
    [5313, 3220, 2213],
    [5596, 3391, 2331],
  ],
  [
    [27, 16, 11],
    [48, 29, 20],
    [77, 47, 32],
    [111, 67, 46],
    [144, 87, 60],
    [178, 108, 74],
    [207, 125, 86],
    [259, 157, 108],
    [312, 189, 130],
    [364, 221, 151],
    [427, 259, 177],
    [489, 296, 203],
    [580, 352, 241],
    [621, 376, 258],
    [703, 426, 292],
    [775, 470, 322],
    [876, 531, 364],
    [948, 574, 394],
    [1063, 644, 442],
    [1159, 702, 482],
    [1224, 742, 509],
    [1358, 823, 565],
    [1468, 890, 611],
    [1588, 963, 661],
    [1718, 1041, 715],
    [1804, 1094, 751],
    [1933, 1172, 805],
    [2085, 1263, 868],
    [2181, 1322, 908],
    [2358, 1429, 982],
    [2473, 1499, 1030],
    [2670, 1618, 1112],
    [2805, 1700, 1168],
    [2949, 1787, 1228],
    [3081, 1867, 1283],
    [3244, 1966, 1351],
    [3417, 2071, 1423],
    [3599, 2181, 1499],
    [3791, 2298, 1579],
    [3993, 2420, 1663],
  ],
  [
    [17, 10, 7],
    [34, 20, 14],
    [58, 35, 24],
    [82, 50, 34],
    [106, 64, 44],
    [139, 84, 58],
    [154, 93, 64],
    [202, 122, 84],
    [235, 143, 98],
    [288, 174, 119],
    [331, 200, 137],
    [374, 227, 155],
    [427, 259, 177],
    [468, 283, 194],
    [530, 321, 220],
    [602, 365, 250],
    [674, 408, 280],
    [746, 452, 310],
    [813, 493, 338],
    [919, 557, 382],
    [969, 587, 403],
    [1056, 640, 439],
    [1108, 672, 461],
    [1228, 744, 511],
    [1286, 779, 535],
    [1425, 864, 593],
    [1501, 910, 625],
    [1581, 958, 658],
    [1677, 1016, 698],
    [1782, 1080, 742],
    [1897, 1150, 790],
    [2022, 1226, 842],
    [2157, 1307, 898],
    [2301, 1394, 958],
    [2361, 1431, 983],
    [2524, 1530, 1051],
    [2625, 1591, 1093],
    [2735, 1658, 1139],
    [2927, 1774, 1219],
    [3057, 1852, 1273],
  ],
]

function getCharNum(eclIndex: number, version: number, mode: number) {
  if (version === 0) {
    return 0
  }
  return charCapacities[eclIndex][version - 1][mode]
}

export function getRandomText(eclIndex: number, version: number, mode: number) {
  const creater = [
    () => String.fromCodePoint(random(49, 57)),
    () => ALPHANUMERIC_CHARS.at(random(0, 44)),
    () => String.fromCodePoint(random(0x4e00, 0x9fa5)),
  ]
  const charNum = getCharNum(eclIndex, version - 1, mode)
  return Array(mode === 2 ? ~~(charNum / 3) + 1 : charNum + 1)
    .fill(0)
    .map(() => creater[mode]())
    .join('')
}

interface DrawMapToCanvasOptions {
  size?: number
  color?: string
  bgColor?: string
  quietZoneModules?: number
}

export function drawMapToCanvas(
  map: number[][],
  canvas: Canvas,
  options: DrawMapToCanvasOptions = {},
) {
  const {
    size = 240,
    color = '#000',
    bgColor = '#fff',
    quietZoneModules = 0,
  } = options
  canvas.width = size
  canvas.height = size
  const context = canvas.getContext('2d')
  const moduleSize = size / (map.length + quietZoneModules * 2)
  const margin = moduleSize * quietZoneModules

  context.clearRect(0, 0, size, size)
  context.fillStyle = bgColor
  context.fillRect(0, 0, size, size)
  context.fillStyle = color

  map.forEach((row, rowIndex) => {
    row.forEach((col, colIndex) => {
      if (col === 1) {
        context.fillRect(
          colIndex * moduleSize + margin,
          rowIndex * moduleSize + margin,
          moduleSize,
          moduleSize,
        )
      }
    })
  })
}

export function createRandomQrcode() {
  const results: [number, number, number, string, string][] = []
  for (let mode = 0; mode < 3; mode++) {
    for (let eclIndex = 0; eclIndex < 4; eclIndex++) {
      const version = 3
      const text = getRandomText(eclIndex, version, mode)
      results.push([
        mode,
        eclIndex,
        version,
        text,
        qrcode(text, {
          ecl: ECLList[eclIndex],
        })
          .map((row) => row.join(''))
          .join(''),
      ])
    }
  }

  return results
}

export const templateData: [
  mode: number,
  eclIndex: number,
  version: number,
  text: string,
  bits: string,
][] = [
  [
    0,
    0,
    3,
    '348225387153986982694353493579848472895687283156376361859634796792865481434748',
    '1111111000110110001111111100000101100001000100000110111010010010100010111011011101011101000101011101101110100011011010101110110000010100001001010000011111111010101010101111111000000000111101010000000011111011100011011101010100000110100010000011100001111100100000111100001000010010000101000101011011100100101010011001111111001111010000110001011101100110110011110101110100101101001110100101111000011011100100101010000111111111100000000110110001000100111111111011011011101011100100000100001011010001001010111010110101011111101011011101010001000110100111101110101111011011110000110000010100110110001111111111111010110011011111101',
  ],
  [
    0,
    1,
    3,
    '5435417618345892661739564688646526345355222732778774828638496336',
    '1111111000011111101111111100000101000110100100000110111010010000001010111011011101001010100101011101101110101011100100101110110000010000111011010000011111111010101010101111111000000000011111100000000010101010000100001000100101011110111101100011010001100000100001100111011001110110000001111101010101101011001111110101001001000011110001011011100011110110010110000101011100111100101100000101001100110100101101111000100111111110100000000100011111000110111111111000101100101010101100000100001101110001111010111010111000111111100011011101001111001100110000101110101001011010101010110000010011011110011001001111111011110000011111101',
  ],
  [
    0,
    2,
    3,
    '5642469479548213533163688232524215771591555224761',
    '1111111001010100101111111100000101001010000100000110111010101101011010111011011101000111001101011101101110100001011110101110110000010000100010010000011111111010101010101111111000000000100001000000000001110110001010111000001101000110100001011111101111011100110101110000101110101010100110011101000100110110011011011001101110101001011001011111000101001001011010100010010000010101001100001111011110100110001100110000010011111011000000000100110001000110011111111001111010101011111100000101011011010001011010111010001100011111110111011101011100100011001001101110101110101000100111010000010111111010000011101111111000100010110100001',
  ],
  [
    0,
    3,
    3,
    '53538335531236555954812632624392673',
    '1111111010011011001111111100000101100101000100000110111010110011000010111011011101000111000101011101101110100110001010101110110000010111000011010000011111111010101010101111111000000001011110010000000000111010110111010111001110001000011110001011000110111011110001001101000001001001101011101111101000111110101010100000100011111111011001110110101100101010101111000100000110101111010010001011010101110011100000110100011011111100100000000101001101000101001111111000001101101011110100000100111100110001100110111010100110001111100001011101011000100111110001101110101000011010001110110000010001010010010001111111111000001000110010001',
  ],
  [
    1,
    0,
    3,
    'Z/JGSR61 +/B+J HLV0EJ1C2J5$ P*KZH2G1*EAMTE5+G-Z7',
    '1111111011101001001111111100000101000101010100000110111010010000101010111011011101001000010101011101101110101010110000101110110000010110010110010000011111111010101010101111111000000001110110000000000011100110100110110111100111110000010001010001101100110110111000101110011000001101000001110011111110010010111101101011011011101001000011110101011110000111000011000111101110001110010100011010110101001110110111100010010011111110100000000100100111000101011111111001100011101011101100000101011011010001100010111010011110111111100101011101000110100001111110101110101110000110000101110000010101011100110010011111111011010001101000011',
  ],
  [
    1,
    1,
    3,
    'J0MU3.AICM%4Z$C-36SOQ4Y/H4M1$A875RC5LQ:',
    '1111111000111111101111111100000101101100010100000110111010111100100010111011011101011100101101011101101110100100111000101110110000010001001001010000011111111010101010101111111000000001000011000000000010000010110111111110011101111010100010101110010010111011111010110010110101010001100101110001110100101011101011001011111011001110100011011010100010111010000011110110111010110111010010110011110100111111101100100110010011111101100000000111100101000111101111111001001001101011010100000100011111010001011010111010010010011111111011011101001000110000110111101110100100111110111110110000010010001110000100001111111010011100011110011',
  ],
  [
    1,
    2,
    3,
    '*PY.2HY%EZ0-*E0EL-8022XM2IU%OL',
    '1111111010110010001111111100000101001101000100000110111010001111010010111011011101000111111001011101101110100010110100101110110000010000100101010000011111111010101010101111111000000000001011110000000001000011110000000100000110011110101110001100000001100100110001000111111101111101100110010111010100010110011110101011011000100100101010010101000100010110101010101001010111011111001010100100110110111010101110100011001111111011000000000100110011000100001111111011111111101010101100000100001101110001001010111010010100101111110101011101000110100001010101101110100000110101000110110000010111000101101001001111111000110001001100111',
  ],
  [
    1,
    3,
    3,
    'N+5LMOXD69Q-II5I5KN2B',
    '1111111011000001101111111100000101011010010100000110111010000011000010111011011101010101001001011101101110101111000010101110110000010101110100010000011111111010101010101111111000000000111100010000000000010010001100100001110110110100101110011001010111101101110110001010111001011110001011111110000001101110101101010010011001001010101011010000100110000110111011110101001101111110110100100011000000001101111010111111101111111010100000000110100001000101001111111000011110101010010100000100101101110001001110111010011001001111111101011101010010001011001010101110100101101010110100110000010010111000110010011111111001000011110111101',
  ],
  [
    2,
    0,
    3,
    '袌縷俧舫椁螜嘵艩踸畠癬',
    '1111111011011111001111111100000100000100100100000110111010111010010010111011011101010100110101011101101110101001001000101110110000010010111111010000011111111010101010101111111000000000110110000000000011110010101001011100111011011110100110110100110101111110101000001111110001111001101110000001000010010101111000010101000011101001101001100000001000101101001111111101111010110011010110101001111101111101001110101100110011111111100000000111100001000100011111111000011000101011010100000100011011010001010010111010000101011111110001011101010110101100110000101110101010101101100111010000010111000100011010001111111010011100110101111',
  ],
  [
    2,
    1,
    3,
    '林廸鵡汋茹叟惰潓譙',
    '1111111001100100101111111100000100111011000100000110111010001011110010111011011101001001010001011101101110100110111000101110110000010110100001010000011111111010101010101111111000000000100010100000000010010110110100001101000001111100010100100111010000000111111011001111101110001101101101110010011101011000011010110111000000010001110011001001010101010010001010001000011111011100111010101011001100001111111100101111100111111111100000000101101111000111011111111000011100101011010100000101011010110001100110111010001011011111110101011101010001011011011100101110100101010010110000110000010000100011010101001111111010000011010000011',
  ],
  [
    2,
    2,
    3,
    '氲舷脖瀅瘇逎釐',
    '1111111011101110101111111100000101001101000100000110111010101001101010111011011101011011011001011101101110101010111010101110110000010001111001010000011111111010101010101111111000000001101001100000000001101011010100111010111110001000011110100111011001001110111010010101100000011101101101110101010001100010001011100010100110001010100000001011101011110110010111101110111010101000100010011110011010001111100000111011110111111011100000000110101001000111111111111010111010101010110100000100110110110001110010111010111001111111110111011101001001000111100000101110101110100110100100110000010110001011001001101111111000100101011000011',
  ],
  [
    2,
    3,
    3,
    '鲝纂壆嗙餹',
    '1111111000010011101111111100000101101111010100000110111010111001010010111011011101010101000001011101101110101011110100101110110000010111100000010000011111111010101010101111111000000000100010000000000000100111101010011101111100010110101000111001111110101111110001111000110011001001001010101100101011011000101101100001010111011010011010000001101001101111010010100110101010000100010000111001100111000110110000111101001111111001000000000100101001000101011111111011000110101011000100000101010001010001011110111010011010001111111001011101000011101001010000101110101101010100110101110000010001000001011011001111111001110110001011001',
  ],
]
