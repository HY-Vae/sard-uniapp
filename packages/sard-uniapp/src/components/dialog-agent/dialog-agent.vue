<template>
  <sar-dialog
    :root-style="innerProps.rootStyle"
    :root-class="innerProps.rootClass"
    v-model:visible="innerProps.visible"
    :title="innerProps.title"
    :message="innerProps.message"
    :headed="innerProps.headed"
    :button-type="innerProps.buttonType"
    :show-cancel="innerProps.showCancel"
    :cancel-text="innerProps.cancelText"
    :show-confirm="innerProps.showConfirm"
    :confirm-text="innerProps.confirmText"
    :overlay-closable="innerProps.overlayClosable"
    :before-close="innerProps.beforeClose"
  />
</template>

<script setup lang="ts">
import { onMounted, onUnmounted, ref } from 'vue'
import SarDialog from '../dialog/dialog.vue'
import {
  type DialogAgentProps,
  dialogAgentPropsDefaults,
  mapIdImperatives,
} from './common'

defineOptions({
  options: {
    virtualHost: true,
    styleIsolation: 'shared',
  },
})

const props = withDefaults(
  defineProps<DialogAgentProps>(),
  dialogAgentPropsDefaults,
)

// main
const innerProps = ref({ ...props })

const imperative = {
  show(newProps: Record<string, any>) {
    innerProps.value = {
      ...props,
      ...newProps,
      visible: true,
    }
  },
  hide() {
    innerProps.value = {
      ...innerProps.value,
      visible: false,
    }
  },
}

onMounted(() => {
  const id = innerProps.value.id
  if (id) {
    mapIdImperatives[id] ??= []
    mapIdImperatives[id].push(imperative)
  }
})

onUnmounted(() => {
  const id = innerProps.value.id
  if (id) {
    const imperatives = mapIdImperatives[id]
    const index = imperatives.indexOf(imperative)
    if (index !== -1) {
      imperatives.splice(imperatives.indexOf(imperative), 1)
    }
  }
})
</script>
